// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorDataAnalytics.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 2 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Blazored.Modal;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Blazored.Modal.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.DropDowns;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Buttons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Inputs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Calendars;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Spinner;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Grids;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.SplitButtons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 20 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Popups;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.RichTextEditor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using BlazorDataAnalytics.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using BlazorDataAnalytics.Dialogs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Microsoft.Identity.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Microsoft.PowerBI.Api;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Microsoft.PowerBI.Api.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Microsoft.Rest;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Microsoft.Azure.Management.DataFactory.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Azure.Analytics.Synapse.Artifacts;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Azure.Identity;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using System.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using BlazorDataAnalytics.Enums;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using BlazorDataAnalytics.Services.KeyVaultManager;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using BlazorDataAnalytics.Services.UserVaultService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
using BlazorDataAnalytics.Services.UserSecurityService;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/datasources")]
    public partial class UserVault : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 73 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\UserVault.razor"
       
    BlazorDataAnalytics.Dialogs.MessageBoxDialog messageBoxDialog;
    BlazorDataAnalytics.Dialogs.PowerBITemplateDialog powerBiTemplateDialog;
    UserVaultDialog UserVaultDialog;
    DeleteUserVaultDialog DeleteUserVaultDialog;
    [CascadingParameter]
    public IModalService Modal { get; set; }

    public string text { get; set; }

    private int customerTenantID { get; set; }
    private bool showSpinner { get; set; } = false;

    private List<UserVaultModel> listUserVaults { get; set; } = new List<UserVaultModel>();

    private UserNameGroupRolesModel userNameGroupRolesModel = new UserNameGroupRolesModel();
    private string userNameIdentity { get; set; }
    private string customerTenantName { get; set; }
    private bool isPowerBITemplate { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userNameGroupRolesModel = await _userSecurityService.GetUserNameGroupRoles(user.Identity.Name);

        customerTenantID = userNameGroupRolesModel.CustomerTenantId;
        customerTenantName = userNameGroupRolesModel.CustomerName;

        await SearchUserVaults();
    }

    //Events
    public async void OnActionBegin(ActionEventArgs<UserVaultModel> args)
    {
        DatasetGovernanceModel model = new DatasetGovernanceModel();

        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Cancel)
        {
            // Triggers once cancel operation completes
        }
        else if (args.RequestType == Syncfusion.Blazor.Grids.Action.Add)
        {
            // Triggers once save operation completes
            args.Cancel = true;
            await AddUserVault();
        }
        else if (args.RequestType == Syncfusion.Blazor.Grids.Action.Delete)
        {
            // Triggers once delete operation completes
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SearchUserVaults();
            StateHasChanged();
        }
    }

    private async Task SearchUserVaults()
    {
        showSpinner = true;
        listUserVaults = await _userVaultService.SearchUserVault(text, customerTenantID);
        showSpinner = false;
        StateHasChanged();
    }


    private void RefreshCustomerPage(bool refreshParentPage)
    {
        if (refreshParentPage)
        {
            this.SearchUserVaults().ConfigureAwait(true);
        }
    }

    private async Task AddUserVault()
    {
        UserVaultModel userVaultModel = null;
        await UserVaultDialog.OpenDialog(userVaultModel);
    }

    private async Task EditUserVault(UserVaultModel userVaultModel)
    {
        isPowerBITemplate = false;
        await UserVaultDialog.OpenDialog(userVaultModel);
    }

    private async Task ViewDeleteUserVault(UserVaultModel userVaultModel)
    {
        isPowerBITemplate = false;
        if (userVaultModel != null)
        {
            DeleteUserVaultDialog.OpenDialog(userVaultModel.Id.Value);
        }
    }
    private async Task ViewPowerBITemplate(UserVaultModel userVaultModel)
    {
        isPowerBITemplate = true;
        StateHasChanged();
        PowerBIClient _client;
        PowerBIEmbedConfig _result;
        Guid _workspaceId;
        Reports _report;
        AuthenticationResult authenticationResult = null;
        authenticationResult = await DoAuthentication();

        var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");
        // var userNameGroupRolesModel = await _userSecurityService.GetUserNameGroupRoles(user.Identity.Name);

        _result = new PowerBIEmbedConfig();
        _client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

        //Retrieve workspace ID from customer
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userNameIdentity = user?.Identity?.Name;
        userNameGroupRolesModel = await _userSecurityService.GetUserNameGroupRoles(userNameIdentity);


        _workspaceId = userNameGroupRolesModel.WorkspaceId; //Customer Workspace

        _report =  _client.Reports.GetReportsInGroup(new Guid( _configuration.GetSection("PowerBiTemplate:WorkspaceId").Value));
       _report.Value = _report.Value.Where(x => x.Name.ToLower().Replace(" ","").Contains(userVaultModel.SystemName.ToLower().Replace(" ", ""))).ToList();

        await powerBiTemplateDialog.OpenDialog(_workspaceId.ToString(), userVaultModel.Id ?? 0, customerTenantID, _client, _report, _result);

    }
    private async Task RunAzureSynapsePipeline(UserVaultModel userVaultModel)
    {
        isPowerBITemplate = false;
        try
        {
            showSpinner = true;
            var credential = new DefaultAzureCredential(new DefaultAzureCredentialOptions
                {
                    ManagedIdentityClientId = _configuration.GetSection("AzureAd:ClientId").Value,
                    InteractiveBrowserTenantId = "94e6b5f2-d1da-4de9-a4ca-88cfdb6c3de0",
                    SharedTokenCacheTenantId = "94e6b5f2-d1da-4de9-a4ca-88cfdb6c3de0",
                    VisualStudioTenantId = "94e6b5f2-d1da-4de9-a4ca-88cfdb6c3de0",
                    SharedTokenCacheUsername = "Eric@qualiticks.com"
                });



            var pipelineClient = new PipelineClient(
            new Uri("https://qtx-daaas.dev.azuresynapse.net"),
            credential);

            var parameters = new Dictionary<string, object>
            {
                { "Customer", customerTenantName },
                { "Application", userVaultModel.SystemName },
            };

            var run = await pipelineClient.CreatePipelineRunAsync("Master", parameters: parameters).ConfigureAwait(false);


            messageBoxDialog.OpenDialog(AlertStatus.Success, "Sync starterd with Id: " + run.Value.RunId);
        }
        catch (Exception ex)
        {

            messageBoxDialog.OpenDialog(AlertStatus.Danger, ex.Message);

        }
        finally
        {
            showSpinner = false;
        }
    }

    private const string AuthorityFormat = "https://login.microsoftonline.com/94e6b5f2-d1da-4de9-a4ca-88cfdb6c3de0/v2.0";
    private const string MSGraphScope = "https://analysis.windows.net/powerbi/api/.default";
    private async Task<Microsoft.Identity.Client.AuthenticationResult> DoAuthentication()
    {
        IConfidentialClientApplication daemonClient;
        daemonClient = ConfidentialClientApplicationBuilder.Create(_configuration.GetSection("AzureAd:ClientId").Value)
            .WithAuthority(string.Format(AuthorityFormat, _configuration.GetSection("AzureAd:TenantId").Value))
            .WithClientSecret(_configuration.GetSection("AzureAd:ClientSecret").Value)
            .Build();

        AuthenticationResult authResult = await daemonClient.AcquireTokenForClient(new[] { MSGraphScope }).ExecuteAsync();
        return authResult;
    }




#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IConfiguration _configuration { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IUserSecurityService _userSecurityService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IUserVaultService _userVaultService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IKeyVaultManager _keyVaultManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AuthenticationStateProvider AuthenticationStateProvider { get; set; }
    }
}
#pragma warning restore 1591
