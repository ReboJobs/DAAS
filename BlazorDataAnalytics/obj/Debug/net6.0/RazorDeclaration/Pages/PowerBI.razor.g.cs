// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorDataAnalytics.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 2 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Blazored.Modal;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Blazored.Modal.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.DropDowns;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Calendars;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Spinner;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Grids;

#line default
#line hidden
#nullable disable
#nullable restore
#line 20 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Popups;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.RichTextEditor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 24 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics.Dialogs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.Threading.Tasks;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using BlazorDataAnalytics.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using BlazorDataAnalytics.Enums;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using BlazorDataAnalytics.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using BlazorDataAnalytics.Services.BookMarkService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using BlazorDataAnalytics.Services.UserService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Microsoft.Identity.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Microsoft.PowerBI.Api;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Microsoft.PowerBI.Api.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Microsoft.Rest;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Newtonsoft.Json.Linq;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Microsoft.Extensions.Configuration;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Syncfusion.Blazor.Buttons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 20 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Persistence.Config.Entities;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.Collections.ObjectModel;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Syncfusion.Blazor.Lists;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Syncfusion.Blazor.Inputs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 24 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Persistence.Config.Entities;

#line default
#line hidden
#nullable disable
#nullable restore
#line 25 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
#nullable restore
#line 26 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 27 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.Net;

#line default
#line hidden
#nullable disable
#nullable restore
#line 28 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Syncfusion.Blazor.Navigations;

#line default
#line hidden
#nullable disable
#nullable restore
#line 29 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Syncfusion.Blazor.SplitButtons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 30 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Newtonsoft;

#line default
#line hidden
#nullable disable
#nullable restore
#line 31 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.Text.RegularExpressions;

#line default
#line hidden
#nullable disable
#nullable restore
#line 32 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 33 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using System.IdentityModel.Tokens.Jwt;

#line default
#line hidden
#nullable disable
#nullable restore
#line 34 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
using BlazorDataAnalytics.Services.ReportThemesService;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/reports")]
    [Microsoft.AspNetCore.Components.RouteAttribute("/reports/{_paramworkspaceId}/{_paramreportId}")]
    [Microsoft.AspNetCore.Components.RouteAttribute("/reports/{_paramworkspaceId}/{_paramreportId}/{_paramEditable}/{_isdashboard}")]
    public partial class PowerBI : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 361 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\PowerBI.razor"
       
	BlazorDataAnalytics.Dialogs.MessageBoxDialog MessageBoxDialog;
	BlazorDataAnalytics.Dialogs.UploadCardPictureDialog UploadCardPictureDialog;
	private ElementReference PowerBIElement;
	private ClaimsPrincipal user;
	private Dashboard _dashBoard;
	private PowerBIEmbedConfig _result;
	private Reports _report;
	private PowerBIClient _client;
	private bool enableButton { get; set; } = false;
	private bool enableButton2 { get; set; } = false;
	private string viewName { get; set; }
	private string reportName { get; set; }
	private string CssClass2 { get; set; }
	private bool Visibility { get; set; } = false;
	private bool Visibility2 { get; set; } = false;
	private bool IsShowTheme { get; set; } = false;
	private string scrollablePaletteValue = "#ffffff";
	private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();
	private UserTrack userTrack = new UserTrack();
	private string[] tagArguments { get;  set; }
	private List<ReportModel>? reportModels = new List<ReportModel>();
	private ReportInDashboardModel reportDashboard = new ReportInDashboardModel();
	private List<ReportModel>? reportFilterModels = new List<ReportModel>();
	private List<TagModel>? tagModels = new List<TagModel>();
	private string checkedValue = "Divergent";

	private IList<Microsoft.PowerBI.Api.Models.Group>? _group;
	private IList<Report>? _reports;
	private Guid _workspaceId, _reportId;
	private Guid _dashBoardId;
	private string previousID;
	private string _authMessage;
	private string _userName;
	private int? _exportStatus= 0;
	private bool isChecked = true;
	private List<BookmarkModel> bookmarkModels = new List<BookmarkModel>();
	SfSidebar rightSidebarInstance;
	[CascadingParameter]
	public IModalService Modal { get; set; }

	[Parameter]
	public string _paramworkspaceId { get; set; }

	[Parameter]
	public string _paramreportId { get; set; }

	[Parameter]
	public string _paramEditable { get; set; }

	[Parameter]
	public string _isdashboard { get; set; }

	private List<BookmarkModel> _bookmarkList = new List<BookmarkModel>(); 
	private string browser { get; set; }
	protected string userName { get; set; }
	private int customerTenantId { get; set; }
	public string Content = "Save";
	public string CssClass = "e-hide-spinner";
	public string _Tag { get; set; }
	public class ThemePallete {
		public int ID{ get; set; }
		public bool IsDefault { get; set; } = false;
		public string name { get; set; }
		public string[] dataColors = new string[8];
		public Dictionary<string, string[]> dataColorsList = new Dictionary<string, string[]>();
		public string foreground{ get; set; }
		public string background{ get; set; }
		public string tableAccent{ get; set; }
	}
	public class ThemePalleteJsonRequest {
		public string name { get; set; }
		public string[] dataColors = new string[8];
		public string foreground{ get; set; }
		public string background{ get; set; }
		public string tableAccent{ get; set; }
	}
	ObservableCollection<ListDataModel> DataSource = new ObservableCollection<ListDataModel>();
	private List<ThemePallete> palleteList = new List<ThemePallete>();
	ThemePallete palletItem = new ThemePallete();


	void OnDelete(ListDataModel listDataModel)
	{
		DataSource.RemoveAt(DataSource.ToList<ListDataModel>().FindIndex(e => e.TagName == listDataModel.TagName));

		var reportDashboard = _reportDashboardService.GetReportsInDashboardByPowerBiId(Guid.Parse(_paramreportId), customerTenantId).Result;
		userTrack.ReportName = reportDashboard.Title;

		string tagInline = @"";
		int countObj = 1;

		foreach(var curModel in DataSource){

			if (countObj == 1)
			{
				tagInline = curModel.TagName;
			}
			else
			{
				tagInline = tagInline + "," + curModel.TagName;
			}

			countObj++;

		}

		using (var db = new DataAnalyticsDBContext())
		{
			var dbBoard = new ReportInDashboard();

			dbBoard = db.ReportInDashboards.Where(c => c.Title == userTrack.ReportName).FirstOrDefault();

			dbBoard.Tags = tagInline;
			db.SaveChanges();

		}


	}
	private void OnBtnClick()
	{
		this.Visibility = !this.Visibility ;
		StateHasChanged();
	}
	private async Task OnBtnClick2()
	{
		this.Visibility2 = !this.Visibility2 ;
		StateHasChanged();
	}
	private async Task OnBtnEditReportClick()
	{
		IsEditMode = true;
		this.RenderReport();
	}
	private async Task ChooseTheme()
	{
		this.IsShowTheme = !this.IsShowTheme ;
		StateHasChanged();
	}
	public void OnInput(InputEventArgs args)
	{
		if (string.IsNullOrEmpty(args.Value)){
			CssClass = "e-error";
		}
		else {
			CssClass2 = "e-success";
			enableButton2 = !string.IsNullOrEmpty(args.Value) ;
		}
		this.StateHasChanged();
	}
	public void OnInput2(InputEventArgs args)
	{
		if (string.IsNullOrEmpty(args.Value)){
			CssClass = "e-error";
		}
		else {
			CssClass2 = "e-success";
			viewName = args.Value;
			enableButton = !string.IsNullOrEmpty(viewName) ;
		}
		this.StateHasChanged();
	}
	public void Begin(Syncfusion.Blazor.SplitButtons.ProgressEventArgs args)
	{
		Content = "Saving.......";
		CssClass = "e-hide-spinner e-info border-radius";
	}
	public async Task End(Syncfusion.Blazor.SplitButtons.ProgressEventArgs args)
	{
		await CaptureViews();
		Content = "Saved";
		CssClass = "e-hide-spinner e-success border-radius";
		await Task.Delay(1000);
		Content = "Save";
		CssClass = "e-hide-spinner border-radius";

	}
	public async Task End2(Syncfusion.Blazor.SplitButtons.ProgressEventArgs args)
	{
		if(reportDashboard.Title== reportName)
		{
			showAlertMessage(AlertStatus.Danger,"Report name must not be the same with current name.","Validation Error!");
			return;

		}
		await  RenameReport();
		Content = "Saved";
		CssClass = "e-hide-spinner e-success border-radius";
		Content = "Save";
		CssClass = "e-hide-spinner border-radius";

	}
	private async Task ApplyTheme()
	{
		try 
		{
			if(string.IsNullOrEmpty(palletItem.name)){
				showAlertMessage(AlertStatus.Warning, "Theme name is required!","Warning!");
				return;
			}
			var reg = "\"([^\"]+)\":";
			ThemePalleteJsonRequest obj= new ThemePalleteJsonRequest();

			obj.name = palletItem.name;
			obj.dataColors = palletItem.dataColors;
			obj.foreground = palletItem.foreground.Substring(0, 7);
			obj.background = palletItem.background.Substring(0, 7);;
			obj.tableAccent = palletItem.tableAccent.Substring(0, 7);;

			for(int i=0; i < obj.dataColors.Length;i++){
				obj.dataColors[i] = obj.dataColors[i].Substring(0,7);
			}

			var jsonText =Newtonsoft.Json.JsonConvert.SerializeObject(obj);

			await Interop.ApplyTheme(JSRuntime, jsonText);

			StateHasChanged();
		} 
		catch (Exception ex) { }
	}
	public async Task setAsTheme()
	{
		try
		{
			var obj = palleteList.Where(x => x.name == checkedValue).FirstOrDefault();
			if (obj != null)
			{
				bool isExisting = await _reportTheme.CheckExist(customerTenantId, reportDashboard.ReportDbId, obj.name);
				if (isExisting)
				{
					await _reportTheme.SetAsDefaultTheme(customerTenantId, reportDashboard.ReportDbId, obj.name);
				}
				else
				{
					ReportThemeModel newTheme = new ReportThemeModel();
					newTheme.CreatedDate = DateTime.Now;
					newTheme.CustomerTenantId = _customerTenantId;
					newTheme.ReportDBID = reportDashboard.ReportDbId;

					obj.foreground = obj.foreground.Substring(0, 7);
					obj.background = obj.background.Substring(0, 7); ;
					obj.tableAccent = obj.tableAccent.Substring(0, 7); ;

					for (int i = 0; i < obj.dataColors.Length; i++)
					{
						obj.dataColors[i] = obj.dataColors[i].Substring(0, 7);
					}

					newTheme.Theme = JsonConvert.SerializeObject(obj);
					newTheme.CreatorUserName = userNameGroupRolesModel.UserName;
					newTheme.ThemeName = obj.name;
					newTheme.IsDefaultTheme = true;

					var response = await _reportTheme.CreateOrUpdateReportTheme(newTheme);
					await _reportTheme.SetAsDefaultTheme(customerTenantId, reportDashboard.ReportDbId, obj.name);
				}
				showAlertMessage(AlertStatus.Success, "Theme has been applied!", "Success!");

			}
		}
		catch (Exception ex) { }
	}
	public async Task SaveTheme()
	{
		try
		{
			var isExisting = await _reportTheme.CheckExist(customerTenantId, reportDashboard.ReportDbId, palletItem.name);
			if (isExisting)
			{
				showAlertMessage(AlertStatus.Warning, "Theme with corresponding name already exist! Please try another name.", "Warning!");
				return;
			}
			ReportThemeModel newTheme = new ReportThemeModel();
			newTheme.CreatedDate = DateTime.Now;
			newTheme.CustomerTenantId = _customerTenantId;
			newTheme.ReportDBID = reportDashboard.ReportDbId;

			palletItem.foreground = palletItem.foreground.Substring(0, 7);
			palletItem.background = palletItem.background.Substring(0, 7); ;
			palletItem.tableAccent = palletItem.tableAccent.Substring(0, 7); ;

			for (int i = 0; i < palletItem.dataColors.Length; i++)
			{
				palletItem.dataColors[i] = palletItem.dataColors[i].Substring(0, 7);
			}

			newTheme.Theme = JsonConvert.SerializeObject(palletItem);
			newTheme.CreatorUserName = userNameGroupRolesModel.UserName;
			newTheme.ThemeName = palletItem.name;
			newTheme.IsDefaultTheme = palletItem.IsDefault;

			await _reportTheme.CreateOrUpdateReportTheme(newTheme);
			if (palletItem.IsDefault)
			{
				await _reportTheme.SetAsDefaultTheme(customerTenantId, reportDashboard.ReportDbId, palletItem.name);
			}

			showAlertMessage(AlertStatus.Success, "New theme added successfully", "Success!");
			await retrieveThemes();
			palletItem = new ThemePallete();
			palletItem.dataColors = new string[] { "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff" };
			palletItem.background="#ffffffff";
			palletItem.foreground="#ffffffff";
			palletItem.tableAccent = "#ffffffff";
		}
		catch (Exception ex) { }
	}
	private void onClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs args)
	{
		//onclick Event triggered
	}
	private void scrollablePaletteChange(ColorPickerEventArgs args)
	{
		ThemePallete pallete = new ThemePallete();
		pallete.name = args.Name;


	}
	private async void onChange(Microsoft.AspNetCore.Components.ChangeEventArgs args)
	{
		//onChange Event triggered
		var reg = "\"([^\"]+)\":";
		checkedValue = args.Value.ToString();
		foreach(var item in palleteList)
		{
			if (item.name== checkedValue)
				item.IsDefault = true;
			else
				item.IsDefault = false;
		}
		var jsonText =Newtonsoft.Json.JsonConvert.SerializeObject(palleteList.Where(x=> x.name.ToLower().Trim()== checkedValue.ToString().ToLower().Trim()).Select(x=>
				new ThemePalleteJsonRequest{
		  name = x.name,
		  dataColors = x.dataColors,
		  foreground = x.foreground,
		  background = x.background,
		  tableAccent = x.tableAccent
		}).FirstOrDefault());
		try {
			await Interop.ApplyTheme(JSRuntime, jsonText);
		} catch (Exception ex) { }
		StateHasChanged();
	}
	public async Task ValueChangeHandler(ChangedEventArgs args) 
	{

		reportModels = new List<ReportModel>();
		List<ReportModel> newReportFilterModels = new List<ReportModel>();

		if(tagArguments != null)
		{
			if(tagArguments.Any())
			{
				foreach (var tagArg in tagArguments)
				{
					if (string.IsNullOrEmpty(reportName))
					{
						newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(tagArg)).ToList();
						if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
						{
							reportModels.AddRange(newReportFilterModels);                       
						}
					}
					else
					{
						newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(tagArg) && x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();
						if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
						{
							reportModels.AddRange(newReportFilterModels);                       
						}
					}
				}
			}
			else
			{
				reportModels = reportFilterModels.Where(x => x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();
			}

		}     
		else
		{
			if (!string.IsNullOrEmpty(reportName))
			{
				reportModels = reportFilterModels.Where(x => x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();;
			}
			else
			{
				reportModels = reportFilterModels;  
			}
		}

	}
	public async Task TagValueChangeHandler(MultiSelectChangeEventArgs<string[]> args) 
	{

		reportModels = new List<ReportModel>();
		List<ReportModel> newReportFilterModels = new List<ReportModel>();

		if (args.Value != null)
		{
			tagArguments = args.Value;
			foreach (var arg in args.Value)
			{
				if (string.IsNullOrEmpty(reportName))
				{
					newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(arg)).ToList();
					if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
					{
						reportModels.AddRange(newReportFilterModels);                       
					}
				}
				else
				{
					newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(arg) && x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();
					if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
					{
						reportModels.AddRange(newReportFilterModels);                       
					}
				}
			}
		}
		else
		{
			tagArguments =  new string[] {};
			reportModels = reportFilterModels;
		}

	}
	private async Task AddItem()
	{
		var random = new Random();
		DataSource.Add(new ListDataModel
		{
			Id = random.Next(100, 300).ToString(),
			TagName = _Tag
		});

		var reportDashboard = _reportDashboardService.GetReportsInDashboardByPowerBiId(Guid.Parse(_paramreportId), customerTenantId).Result;
		userTrack.ReportName = reportDashboard.Title;

		string tagInline = @"";
		int countObj = 1;

		foreach(var curModel in DataSource){

			if (countObj == 1)
			{
				tagInline = curModel.TagName;
			}
			else
			{
				tagInline = tagInline + "," + curModel.TagName;
			}

			countObj++;

		}

		using (var db = new DataAnalyticsDBContext())
		{
			var dbBoard = new ReportInDashboard();

			dbBoard = db.ReportInDashboards.Where(c => c.Title == userTrack.ReportName).FirstOrDefault();

			dbBoard.Tags = tagInline;
			db.SaveChanges();

		}

		_Tag = string.Empty;
	}

	public class ListDataModel
	{
		public string Id { get; set; }
		public string TagName { get; set; }
	}

	async void LocationChanged(object sender, LocationChangedEventArgs e)
	{
		//RenderReport();
	}

	async void RenderReport()
	{
		_result = new PowerBIEmbedConfig();
		AuthenticationResult authenticationResult = null;
		authenticationResult = await DoAuthentication();
		var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

		_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

		var groups = await _client.Groups.GetGroupsAsync();
		_group = groups.Value;


		if (!String.IsNullOrEmpty(_paramworkspaceId ) && !String.IsNullOrEmpty(_paramreportId))
		{
			var clientReport = _client.Reports.GetReport(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));

			_workspaceId = Guid.Parse(_paramworkspaceId);
			_reportId = Guid.Parse(_paramreportId);

			await ReportChange(clientReport,"false");

		}

		StateHasChanged();
	}
	private string userNameIdentity { get; set; }
	private UserNameGroupRolesModel userNameGroupRolesModel = new UserNameGroupRolesModel();
	private int _customerTenantId;
	private bool IsEditMode { get; set; } = false;
	private bool IsAdminUser{ get; set; } = false;
	private async Task RenderBookmarks()
	{   

		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		userNameIdentity = user?.Identity?.Name;
		userNameGroupRolesModel = await _userSecurityService.GetUserNameGroupRoles(userNameIdentity); 

		if(userNameGroupRolesModel.WorkspaceId == Guid.Empty)
		{
			return;
		}

		AuthenticationResult authenticationResult = null;
		authenticationResult = await DoAuthentication();
		var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

		_result = new PowerBIEmbedConfig();
		_reports = new List<Report>();
		_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

		_customerTenantId = userNameGroupRolesModel.CustomerTenantId;


		var reportInDashboards = await _reportDashboardService.GetReportsInDashboardByTenantId(_customerTenantId, await GetCustomerTenantSid());

		bookmarkModels = await _reportDashboardService.GetBookmarksInDashboardByTenantId(_customerTenantId, userNameIdentity);

		if((!userNameGroupRolesModel.IsAdmin || !userNameGroupRolesModel.ViewAllReport) && reportInDashboards != null)
		{
			bookmarkModels = bookmarkModels.Where(r => userNameGroupRolesModel.CustomerUserRoles.Any(a => a.Code == 
													reportInDashboards?.FirstOrDefault(x => x.ReportDbId == r.ReportDbid).UserRoleCode)).ToList();
		}
	}
	public async Task<string> GetCustomerTenantSid()
	{
		string resource = "https://management.azure.com";
		var clientId = _configuration.GetSection("AzureAd:ClientId").Value;
		var secret = _configuration.GetSection("AzureAd:ClientSecret").Value;
		var oauthUrl = _configuration.GetSection("AzureAd:Instance").Value + _configuration.GetSection("workSpaceId").Value + "/oauth2/token";
		var content = new FormUrlEncodedContent(new Dictionary <string, string> {
                                      { "client_id", clientId},
                                      { "client_secret", secret},
                                      { "grant_type", "client_credentials" },
                                      { "resource", resource},
                                      { "scope", "user_impersonation"}
                                    });

		var httpRequestMessage = new HttpRequestMessage(HttpMethod.Post, new Uri(oauthUrl))
                            {
                                Content = content
                            };

		var _httpClient = new HttpClient();
		using (var response = await _httpClient.SendAsync(httpRequestMessage))
		{
			if (response.IsSuccessStatusCode)
			{
				var responseStream = await response.Content.ReadAsStringAsync();

				AnalyticsTokenModel analyticsToken = JsonConvert.DeserializeObject<AnalyticsTokenModel>(responseStream);

				var handler = new JwtSecurityTokenHandler();
				var jsonToken = handler.ReadToken(analyticsToken.access_token);
				var tokenS = jsonToken as JwtSecurityToken;

				if (tokenS.Claims.First(claim => claim.Type == "groups") != null)
				{
					return tokenS.Claims.First(claim => claim.Type == "groups").Value;
				} 

			}
		}

		return "";
	}
	async void RenderDashboard()
	{
		_result = new PowerBIEmbedConfig();
		AuthenticationResult authenticationResult = null;
		authenticationResult = await DoAuthentication();
		var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

		_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

		var groups = await _client.Groups.GetGroupsAsync();
		_group = groups.Value;


		if (!String.IsNullOrEmpty(_paramworkspaceId) && !String.IsNullOrEmpty(_paramreportId))
		{
			var clientDashboard = _client.Dashboards.GetDashboard(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));

			_workspaceId = Guid.Parse(_paramworkspaceId);
			_reportId = Guid.Parse(_paramreportId);

			await DashboardChange(clientDashboard,"false");

		}

		StateHasChanged();
	}

	private async Task ChangeReport()
	{
		_result = new PowerBIEmbedConfig();
		AuthenticationResult authenticationResult = null;
		authenticationResult = await DoAuthentication();
		var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

		_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

		var groups = await _client.Groups.GetGroupsAsync();
		_group = groups.Value;

		if (!String.IsNullOrEmpty(_paramworkspaceId ) && !String.IsNullOrEmpty(_paramreportId))
		{

			if (_isdashboard == "false")
			{
				var clientReport = _client.Reports.GetReport(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));

				_workspaceId = Guid.Parse(_paramworkspaceId);
				_reportId = Guid.Parse(_paramreportId);

				await ReportChange(clientReport,"true");

			}
			else
			{
				var clientDashboard = _client.Dashboards.GetDashboard(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));

				_workspaceId = Guid.Parse(_paramworkspaceId);
				_reportId = Guid.Parse(_paramreportId);

				await DashboardChange(clientDashboard,"true");

			}

		}

		StateHasChanged();
	}
	private async Task BookmarkChangeHandler(Syncfusion.Blazor.DropDowns.ChangeEventArgs<String, BookmarkModel> args)
	{      
		_report = await _client.Reports.GetReportsInGroupAsync(_workspaceId);
		_reports = _report.Value;


		Report clientReport = _reports.Where(c=>c.Name == args.ItemData.Title).SingleOrDefault();
		ReportModel reportModel = new ReportModel()
            {
                Id = clientReport.Id,
                Name = clientReport.Name,
                DatasetId = clientReport.DatasetId,
                AppId = clientReport.AppId,
                Description = clientReport.Description,
                ReportType = clientReport.ReportType,
                WebUrl = clientReport.WebUrl,
                EmbedUrl = clientReport.EmbedUrl,
            };
		reportName=  clientReport.Name;
		await GoToReport(reportModel, "false", "false");
	}
	private async Task GoToReport(ReportModel report,string editable = "false",string isdashboard="false")
	{
		if (report.ReportType.Contains("Dashboard"))
		{
			isdashboard = "true";
			UriHelper.NavigateTo($"/reports/{_workspaceId.ToString()}/{report.Id}/{editable}/{isdashboard}");
		}else
		{
			UriHelper.NavigateTo($"/reports/{_workspaceId.ToString()}/{report.Id}/{editable}/{isdashboard}");
		}
		filterstate.SetFilterShow(report.WebUrl);
	}
	public async Task  ResumeCapacity()
	{
		try
		{
			var enabledCapacity =  _configuration.GetSection("EnableCapacity").Value;
			if(enabledCapacity != "Enabled")
			{
				return;
			}
			string CapacityResource = "https://management.azure.com";
			string ResumeCapacitiesURL = _configuration.GetSection("CapacityResumeApiUrl").Value;
			var clientId = _configuration.GetSection("AzureAd:ClientId").Value;
			var secret = _configuration.GetSection("AzureAd:ClientSecret").Value;
			var oauthUrl = _configuration.GetSection("AzureAd:Instance").Value + _configuration.GetSection("workSpaceId").Value + "/oauth2/token";
			var content = new FormUrlEncodedContent(new Dictionary
								<string, string> {
						  { "client_id", clientId},
						  { "client_secret", secret},
						  { "grant_type", "client_credentials" },
						  { "resource", CapacityResource},
						  { "scope", "user_impersonation"}
						});

			var httpRequestMessage = new HttpRequestMessage(HttpMethod.Post, new Uri(oauthUrl))
					{
						Content = content
					};

			var _httpClient = new HttpClient();
			using (var response = await _httpClient.SendAsync(httpRequestMessage))
			{
				if (response.IsSuccessStatusCode)
				{
					var responseStream = await response.Content.ReadAsStringAsync();

					AnalyticsTokenModel analyticsToken = JsonConvert.DeserializeObject<AnalyticsTokenModel>(responseStream);

					var _httpClient3 = new HttpClient();
					_httpClient3.DefaultRequestHeaders.Add("Authorization", "Bearer " + analyticsToken.access_token);

					var httpRequestMessage33 = new HttpRequestMessage(HttpMethod.Post, new Uri(ResumeCapacitiesURL)){  };

					using (var response3 = await _httpClient3.SendAsync(httpRequestMessage33))
					{
						var responseStream33 = await response3.Content.ReadAsStringAsync();
					}
				}
			}
		}
		catch (Exception ex){ }
	}

	protected override async Task OnInitializedAsync()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		user = authState.User;
		userName = user?.Identity?.Name;

		bool hasViewAllReport = false;


		var userNameGroupRoles = await _userSecurityService.GetUserNameGroupRoles(userName);
		if(userNameGroupRoles != null)
		{
			customerTenantId = userNameGroupRoles.CustomerTenantId;
			hasViewAllReport = userNameGroupRoles.ViewAllReport;
			IsAdminUser = userNameGroupRoles.IsAdmin;
		}

		reportDashboard = await _reportDashboardService.GetReportsInDashboardByPowerBiId(Guid.Parse(_paramreportId), customerTenantId);
		reportName = reportDashboard.Title;
		if(reportDashboard == null)
		{
			UriHelper.NavigateTo($"/");
			return;               
		}

		bool hasUserRole = await _userSecurityService.CheckUserGroupRole(userName, reportDashboard.UserRoleCode);

		if(!hasUserRole && !hasViewAllReport)
		{
			UriHelper.NavigateTo($"/");
			return;
		}

		UriHelper.LocationChanged += LocationChanged;
		await ResumeCapacity();
		await GetViews();
		await RenderBookmarks();
		//Themes
		palleteList = new List<ThemePallete>();
		palletItem.dataColors = new string[] { "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff" };
		palletItem.background="#ffffffff";
		palletItem.foreground="#ffffffff";
		palletItem.tableAccent = "#ffffffff";
		await retrieveThemes();

		filterstate.IsShowHideFilter = false;
		filterstate.OnChange += StateHasChanged;
	}
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (_paramreportId != previousID)
		{
			firstRender = true;
		}
		else
		{
			firstRender = false;
		}

		if (firstRender)
		{
			await ResumeCapacity();
			rightSidebarInstance.IsOpen =false;
			if (_isdashboard == "true")
			{
				RenderDashboard();
			}
			else
			{
				RenderReport();
			}
			previousID = _paramreportId;


			userTrack =  await _apiClientService.GetUserIPAsync();

			if (user.Identity.IsAuthenticated)
			{
				_authMessage = $"{user.Identity.Name} is authenticated.";
				claims = user.Claims;
				userName = claims?.FirstOrDefault(x => x.Type.Equals("name", StringComparison.OrdinalIgnoreCase))?.Value;
				userTrack.UserEmail = user.Identity.Name;
			}
			else
			{
				_authMessage = "The user is NOT authenticated.";
			}
			try
			{

				userTrack.Page = "reports";
				userTrack.Browser = string.Empty;
				userTrack.Browser = string.Empty;
				userTrack.DateTimeLog = DateTime.Now;
				userTrack.UserName = userName;

				userTrack.ReportName = reportDashboard.Title ?? string.Empty;

				using (var db = new DataAnalyticsDBContext())
				{
					string[] tagLines = { };
					try
					{
						DataSource = new ObservableCollection<ListDataModel>();
						var dbBoard = new ReportInDashboard();

						dbBoard = db.ReportInDashboards.Where(c => c.Title == userTrack.ReportName).FirstOrDefault();

						if (dbBoard.Tags != null)
						{
							tagLines = dbBoard.Tags.Split(',');
						}

						var random = new Random();

						if (dbBoard.Tags == null)
						{
							DataSource.Add(new ListDataModel
								{
									Id = random.Next(100, 300).ToString(),
									TagName = string.Empty
								});
						}
						else
						{
							tagLines = dbBoard.Tags.Split(',');

							foreach (var tag in tagLines)
							{
								DataSource.Add(new ListDataModel
									{
										Id = random.Next(100, 300).ToString(),
										TagName = tag
									});
							}

						}

						db.Add(userTrack);
						db.SaveChanges();
					}
					catch (Exception ex)
					{

						Console.WriteLine("\nError Message ---\n{0}", ex.Message);
					}

				}
			}
			catch (Exception ex) { }

		}

		//await InvokeAsync(StateHasChanged);
		await GetViews();
		await Task.Delay(5000);
		await applyDefaultTheme();
	}
	private async Task applyDefaultTheme(){
		try
		{
			ThemePalleteJsonRequest obj = new ThemePalleteJsonRequest();
			var objDefault = palleteList.Where(x => x.IsDefault == true).FirstOrDefault();

			if (objDefault != null)
			{
				obj.name = objDefault.name;
				obj.foreground = objDefault.foreground.Substring(0, 7);
				obj.background = objDefault.background.Substring(0, 7); ;
				obj.tableAccent = objDefault.tableAccent.Substring(0, 7); ;

				for (int i = 0; i < objDefault.dataColors.Length; i++)
				{
					obj.dataColors[i] = objDefault.dataColors[i].Substring(0, 7);
				}

				var jsonText = Newtonsoft.Json.JsonConvert.SerializeObject(obj);

				await Interop.ApplyTheme(JSRuntime, jsonText);
			}
		}
		catch (Exception ex) { }
	}
	private async Task retrieveThemes(){
		try
		{
			palleteList = new List<ThemePallete>();
			var themePallets = await _reportTheme.GetReportTheme(customerTenantId, reportDashboard.ReportDbId);
			if (themePallets != null)
			{
				foreach (var item in themePallets)
				{
					var jsonObj = JsonConvert.DeserializeObject<ThemePallete>(item.Theme);
					jsonObj.dataColorsList = new Dictionary<string, string[]>();
					jsonObj.dataColorsList.Add(jsonObj.name, jsonObj.dataColors);
					jsonObj.ID = item.ID;
					jsonObj.IsDefault = item.IsDefaultTheme ?? false;
					jsonObj.name = item.ThemeName;

					if (jsonObj != null)
						palleteList.Add(jsonObj);

				}
			}

			ThemePallete item2 = new ThemePallete();
			item2.name = "Divergent";
			item2.dataColorsList.Add("Divergent", new string[] { "#B73A3A", "#EC5656", "#F28A90", "#F8BCBD", "#99E472", "#23C26F", "#0AAC00", "#026645" });
			item2.dataColors = new string[] { "#B73A3A", "#EC5656", "#F28A90", "#F8BCBD", "#99E472", "#23C26F", "#0AAC00", "#026645" };
			item2.foreground = "#252423";
			item2.background = "#F4F4F4";
			item2.tableAccent = "#B73A3A";

			ThemePallete item3 = new ThemePallete();
			item3.name = "Executive";
			item3.dataColorsList.Add("Executive", new string[] { "#B73A3A", "#EC5656", "#F28A90", "#F8BCBD", "#99E472", "#23C26F", "#0AAC00", "#026645" });
			item3.dataColors = new string[] { "#B73A3A", "#EC5656", "#F28A90", "#F8BCBD", "#99E472", "#23C26F", "#0AAC00", "#026645" };
			item3.foreground = "#FFFFFF";
			item3.background = "#9C5252";
			item3.tableAccent = "#6076B4";

			ThemePallete item4 = new ThemePallete();
			item4.name = "Tidal";
			item4.dataColorsList.Add("Tidal", new string[] { "#094782", "#0B72D7", "#098BF5", "#54B5FB", "#71C0A7", "#57B956", "#478F48", "#326633" });
			item4.dataColors = new string[] { "#094782", "#0B72D7", "#098BF5", "#54B5FB", "#71C0A7", "#57B956", "#478F48", "#326633" };
			item4.foreground = "#094782";
			item4.background = "#F4F4F4";
			item4.tableAccent = "#094782";
			if (palleteList.Where(x => x.name == item2.name).FirstOrDefault() == null)
				palleteList.Add(item2);
			if (palleteList.Where(x => x.name == item3.name).FirstOrDefault() == null)
				palleteList.Add(item3);
			if (palleteList.Where(x => x.name == item4.name).FirstOrDefault() == null)
				palleteList.Add(item4);

			var objDefault = palleteList.Where(x => x.IsDefault == true).FirstOrDefault();

			if (objDefault != null)
			{
				checkedValue = objDefault.name;
			}
		}
		catch (Exception ex) { }
	}
	private async Task ReportChange(Report report,string fullscreen="false")
	{
		var generateTokenRequestParameters = new GenerateTokenRequest(accessLevel:"edit");
		var tokenResponse = _client.Reports.GenerateTokenAsync(new Guid(_workspaceId.ToString()), new Guid(_reportId.ToString()), generateTokenRequestParameters).Result;

		await Interop.CreateReport(JSRuntime, PowerBIElement,tokenResponse.Token, report.EmbedUrl, report.Id.ToString(),IsEditMode? "true": "false",fullscreen);

		await applyDefaultTheme();
	}


	private async Task DashboardChange(Dashboard dashboard,string fullscreen="false")
	{
		var generateTokenRequestParameters = new GenerateTokenRequest();
		var tokenResponse = _client.Dashboards.GenerateTokenAsync(new Guid(_workspaceId.ToString()), new Guid(_reportId.ToString()), generateTokenRequestParameters).Result;

		_result.EmbedToken = tokenResponse;
		_result.EmbedUrl = dashboard.EmbedUrl;
		_result.Id = dashboard.Id.ToString();

		await Interop.CreateDashboard(JSRuntime, PowerBIElement,tokenResponse.Token, _result.EmbedUrl, _result.Id.ToString(),fullscreen);
		await applyDefaultTheme();
	}

	private const string AuthorityFormat = "https://login.microsoftonline.com/94e6b5f2-d1da-4de9-a4ca-88cfdb6c3de0/v2.0";
	private const string MSGraphScope = "https://analysis.windows.net/powerbi/api/.default";
	private async Task<AuthenticationResult> DoAuthentication()
	{
		IConfidentialClientApplication daemonClient;
		daemonClient = ConfidentialClientApplicationBuilder.Create(_configuration.GetSection("AzureAd:ClientId").Value)
			.WithAuthority(string.Format(AuthorityFormat, _configuration.GetSection("AzureAd:TenantId").Value))
			.WithClientSecret(_configuration.GetSection("AzureAd:ClientSecret").Value)
			.Build();

		AuthenticationResult authResult = await daemonClient.AcquireTokenForClient(new[] { MSGraphScope }).ExecuteAsync();
		return authResult;
	}

	private async Task UploadCardPicture()
	{
		var options = new ModalOptions { UseCustomLayout = true };
		var modalParams = new ModalParameters();

		using (var db = new DataAnalyticsDBContext())
		{
			var dbBoard = db.ReportInDashboards.FirstOrDefault(c => c.Title == userTrack.ReportName);

			if(dbBoard != null)
			{
				UploadCardPictureDialog.OpenDialog();
				StateHasChanged();
			}

		}

	}
	private async Task ItemSelected(MenuEventArgs args)
	{
		if (!string.IsNullOrEmpty(args.Item.Id))
		{
			var state = _bookmarkList.Where(x => x.Id.ToString() == args.Item.Id).FirstOrDefault().state;
			await Interop.ApplyState(JSRuntime, state);
			StateHasChanged();
		}
	}
	private async Task ApplyState(BookmarkModel model)
	{
		await Interop.ApplyState(JSRuntime,model.state);
		StateHasChanged();


	}
	private async Task RenameReport() { 

		PowerBIClient _client;
		PowerBIEmbedConfig _result;
		Reports _report;
		AuthenticationResult authenticationResult = null;
		authenticationResult = await DoAuthentication();


		var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");
		// var userNameGroupRolesModel = await _userSecurityService.GetUserNameGroupRoles(user.Identity.Name);

		_result = new PowerBIEmbedConfig();
		_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

		CloneReportRequest cloneReportRequest = new CloneReportRequest();
		cloneReportRequest.Name = this.reportName;
		cloneReportRequest.TargetWorkspaceId = _workspaceId;
		try{

			var cloned = _client.Reports.CloneReportInGroup(_workspaceId,Guid.Parse(_paramreportId), cloneReportRequest);
			_client.Reports.DeleteReport(_workspaceId,Guid.Parse(_paramreportId));

			showAlertMessage(AlertStatus.Success,"Report successfully renamed to: "+ reportName,"Success Message!");

			this.Visibility2 = !this.Visibility2;
			_paramreportId = cloned.Id.ToString();
			StateHasChanged();

		}catch(Exception ex)
		{
			showAlertMessage(AlertStatus.Danger,ex.Message,"Error Message!");
		}
	}

	private async Task CaptureViews()
	{
		var clientReport = _client.Reports.GetReport(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));
		var generateTokenRequestParameters = new GenerateTokenRequest(accessLevel: "edit");
		var tokenResponse = _client.Reports.GenerateTokenAsync(new Guid(_workspaceId.ToString()), new Guid(_reportId.ToString()), generateTokenRequestParameters).Result;

		_result.EmbedToken = tokenResponse;
		_result.EmbedUrl = clientReport.EmbedUrl;
		_result.Id = clientReport.Id.ToString();

		var test=  await Interop.CaptureViews(JSRuntime, PowerBIElement,tokenResponse.Token, _result.EmbedUrl, _result.Id.ToString(),_paramEditable,"false");
		var obj = Newtonsoft.Json.JsonConvert.DeserializeObject<CaptureState>(test.ToString());
		BookmarkModel model = new BookmarkModel();
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		var objUser =  await _userService.GetUsers(user.Identity.Name);
		model.DisplayName = obj.displayName;
		model.IsActive = true;
		model.Title = viewName;
		model.state = obj.state;
		model.UserId  = objUser.userID;
		model.ReportId = _paramreportId;

		var bookmark=await _bookmarkService.UpsertBookmark(model);
		this.Visibility = !this.Visibility ;
		StateHasChanged();
		MessageBoxDialog.OpenDialog(AlertStatus.Success, string.Format("Views for '{0}' successfully saved.", model.Title));
		viewName = string.Empty;

		await GetViews();
		StateHasChanged();
	}
   private void showAlertMessage(string alertType, string message, string title)
	{
	   MessageBoxDialog.OpenDialog(AlertStatus.Success, message);
	}
	private async Task GetViews()
	{
		var objUser =  await _userService.GetUsers(user.Identity.Name);
		_bookmarkList.Clear();
		_bookmarkList = await _bookmarkService.GetBookmarkInReportByReportId(_paramreportId, objUser.userID);
		//var obj = Newtonsoft.Json.JsonConvert.DeserializeObject<CaptureState>(test.ToString());
		//{"name":"Bookmarkc17602c5b0932a401c66","displayName":"Bookmark 1","state":"H4sIAAAAAAAAA+1XXU/jOBT9K1VeZkaKVk7SNAlvUECMlkVsi9iHFQ839k3rwY2zjsPSQf3vazspbaFsEYOGSrsvqLm+vj4+98OHB4/xuhIwv4AZegfekZS3M1C3vcDzvXLTRoNkQEIa5ySLQuiTgA4GxktWmsuy9g4ePA1qgvqa1w0IG9AY/7zxPRDiEib2qwBRo+9VqGpZguDfsXU2S1o1uPA9vK+EVGBDjjVotGHvjLv5NlCCXyJzIlDN73CMVLfWEVZS6e47A5YMWJywgmJsEKYB7Zs9dbvqYO72t4c6YENZauClAWBtaRQNaJIUGYsZIzmjaQzWXnChO5d8fnJfKXNvw8a8svQdsjsoKTLPXU5h3d7lwRtK0czcr5MN+1g2iuIIC7dUaq7nJszvDap54C0MR5dKGgad9cz4OttU/j1UaAhj3gFZ+LtP/w2hbhT+2PFXUoPoDU2C6954ygvdC/YKTbhXaKItaG6MpeblRHSdsCq9qxYkGN/hFJS2rZZ/M0Vr68zskoqhOpq7UjvmatkNgf8E8zuW2eJm2Xxm7dtaRw3NdSZStWDe8cCbhbXHQRpinwxoSDApIkbzPH+57bqpdeoW47TIaEwYZCTJkgQgS3NDZFcAHWxODe9+F85Gu14OnND3TpWcubjdhPzLeD4F73ttsogl6I8p2tJxRJSM6+72F1I/p+TrE5rq1xPYfjhAT7gb4cRucNm6BtG4MWzCnnNzvbbCnNm4lo0Q1tHyvHC1uNkIZ9zsUHQ6P8c7FM8RPa6/IdtrezvIvZXJOnRnru7zpHd8jwKdIjtevWAtf5zZM2tqGPnK2haYVaB4vWyI5devvGwDnWOh36tX1uCO+GTq4r5MvSvwzTf485GA8vaLZ/PxsL1U9zBLZ9KAf8N8qwWnpuvWh5s3Q6Mj7A8GGlxKq5Zfju26ZG4ZXc9vpffTEdScfmoZvrHvv1hOyGfham141WOHcuz8dgR3MuYxtAGJIygnuCU0L6loGF5JBvMdQa0A6mIufvJ4PynZFXfpe3HCPw6SPSm31ZBrnwgz5ZM4GCRGw9EIkaZIXGr/rfQ03utc3m8+rDbaIC0CEoYkCYOsH/aLIC+S/7TOOzQS3Cj43gjryhQE9my59D7PePllD3TfbnQfqQN3o9umC/cH3Tbu/letu1VrnwZZ2I8jmoWswCKlUZK9VrX2ISiSiKSEJUgyCAKElWr9sILYXqYbyGkQhjGLCMUoJCSjSQDwkt5+/yl5DPOeE1G7gZKknwUF0nxAEkLzfpoNoldQfDiZKJzAUtS/f80etzLwQrqF06bsGiR6QxMKXuIPNeFH3vbnde1a1bT/By22i1HZ6LoCipdQbpN6plCgZMheKfN8myuei11Cdl1r2j//AJV1PNOyEwAA"}"
  //"name":"Bookmarkc17602c5b0932a401c66","displayName":"Bookmark 1","state":"H4sIAAAAAAAAA+1XXU/jOBT9K1VeZkaKVk7SNAlvUECMlkVsi9iHFQ839k3rwY2zjsPSQf3vazspbaFsEYOGSrsvqLm+vj4+98OHB4/xuhIwv4AZegfekZS3M1C3vcDzvXLTRoNkQEIa5ySLQuiTgA4GxktWmsuy9g4ePA1qgvqa1w0IG9AY/7zxPRDiEib2qwBRo+9VqGpZguDfsXU2S1o1uPA9vK+EVGBDjjVotGHvjLv5NlCCXyJzIlDN73CMVLfWEVZS6e47A5YMWJywgmJsEKYB7Zs9dbvqYO72t4c6YENZauClAWBtaRQNaJIUGYsZIzmjaQzWXnChO5d8fnJfKXNvw8a8svQdsjsoKTLPXU5h3d7lwRtK0czcr5MN+1g2iuIIC7dUaq7nJszvDap54C0MR5dKGgad9cz4OttU/j1UaAhj3gFZ+LtP/w2hbhT+2PFXUoPoDU2C6954ygvdC/YKTbhXaKItaG6MpeblRHSdsCq9qxYkGN/hFJS2rZZ/M0Vr68zskoqhOpq7UjvmatkNgf8E8zuW2eJm2Xxm7dtaRw3NdSZStWDe8cCbhbXHQRpinwxoSDApIkbzPH+57bqpdeoW47TIaEwYZCTJkgQgS3NDZFcAHWxODe9+F85Gu14OnND3TpWcubjdhPzLeD4F73ttsogl6I8p2tJxRJSM6+72F1I/p+TrE5rq1xPYfjhAT7gb4cRucNm6BtG4MWzCnnNzvbbCnNm4lo0Q1tHyvHC1uNkIZ9zsUHQ6P8c7FM8RPa6/IdtrezvIvZXJOnRnru7zpHd8jwKdIjtevWAtf5zZM2tqGPnK2haYVaB4vWyI5devvGwDnWOh36tX1uCO+GTq4r5MvSvwzTf485GA8vaLZ/PxsL1U9zBLZ9KAf8N8qwWnpuvWh5s3Q6Mj7A8GGlxKq5Zfju26ZG4ZXc9vpffTEdScfmoZvrHvv1hOyGfham141WOHcuz8dgR3MuYxtAGJIygnuCU0L6loGF5JBvMdQa0A6mIufvJ4PynZFXfpe3HCPw6SPSm31ZBrnwgz5ZM4GCRGw9EIkaZIXGr/rfQ03utc3m8+rDbaIC0CEoYkCYOsH/aLIC+S/7TOOzQS3Cj43gjryhQE9my59D7PePllD3TfbnQfqQN3o9umC/cH3Tbu/letu1VrnwZZ2I8jmoWswCKlUZK9VrX2ISiSiKSEJUgyCAKElWr9sILYXqYbyGkQhjGLCMUoJCSjSQDwkt5+/yl5DPOeE1G7gZKknwUF0nxAEkLzfpoNoldQfDiZKJzAUtS/f80etzLwQrqF06bsGiR6QxMKXuIPNeFH3vbnde1a1bT/By22i1HZ6LoCipdQbpN6plCgZMheKfN8myuei11Cdl1r2j//AJV1PNOyEwAA"}"  
  }
	#region Export Report
	private async Task<string> PostExportRequest(
	Guid reportId,
	Guid groupId,
	FileFormat format,
	IList<string> pageNames = null, /* Get the page names from the GetPages REST API */
	string urlFilter = null)
	{
		var powerBIReportExportConfiguration = new PowerBIReportExportConfiguration
	{
		Settings = new ExportReportSettings
		{
			Locale = "en-us",
		},
		// Note that page names differ from the page display names
		// To get the page names use the GetPages REST API
		Pages = pageNames?.Select(pn => new ExportReportPage(pageName: pn)).ToList(),
		// ReportLevelFilters collection needs to be instantiated explicitly
		ReportLevelFilters = !string.IsNullOrEmpty(urlFilter) ? new List<ExportFilter>() { new ExportFilter(urlFilter) } : null,

	};

		var exportRequest = new ExportReportRequest
	{
		Format = format,
		PowerBIReportConfiguration = powerBIReportExportConfiguration,
	};
		AuthenticationResult authenticationResult = null;
		authenticationResult = await DoAuthentication();
		var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

		_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

		// The 'Client' object is an instance of the Power BI .NET SDK
		var export = await _client.Reports.ExportToFileInGroupAsync(groupId, reportId, exportRequest);

		// Save the export ID, you'll need it for polling and getting the exported file
		return export.Id;
	}
	private async Task<HttpOperationResponse<Export>> PollExportRequest(
		Guid reportId,
		Guid groupId,
		string exportId /* Get from the PostExportRequest response */,
		int timeOutInMinutes,
		CancellationToken token)
	{
		HttpOperationResponse<Export> httpMessage = null;
		Export exportStatus = null;
		DateTime startTime = DateTime.UtcNow;
		const int c_secToMillisec = 1000;
		do
		{
			if (DateTime.UtcNow.Subtract(startTime).TotalMinutes > timeOutInMinutes || token.IsCancellationRequested)
			{
				// Error handling for timeout and cancellations 
				return null;
			}

			// The 'Client' object is an instance of the Power BI .NET SDK
			AuthenticationResult authenticationResult = null;
			authenticationResult = await DoAuthentication();
			var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

			_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);
			httpMessage = await _client.Reports.GetExportToFileStatusInGroupWithHttpMessagesAsync(groupId, reportId, exportId);
			exportStatus = httpMessage.Body;

			// You can track the export progress using the PercentComplete that's part of the response
			//  SomeTextBox.Text = string.Format("{0} (Percent Complete : {1}%)", exportStatus.Status.ToString(), exportStatus.PercentComplete);
			_exportStatus =exportStatus.PercentComplete== 0 ? 40 : exportStatus.PercentComplete;
			StateHasChanged();
			if (exportStatus.Status == ExportState.Running || exportStatus.Status == ExportState.NotStarted)
			{
				// The recommended waiting time between polling requests can be found in the RetryAfter header
				// Note that this header is not always populated
				var retryAfter = httpMessage.Response.Headers.RetryAfter;
				var retryAfterInSec = retryAfter.Delta.Value.Seconds;
				await Task.Delay(retryAfterInSec * c_secToMillisec);
			}
		}
		// While not in a terminal state, keep polling
		while (exportStatus.Status != ExportState.Succeeded && exportStatus.Status != ExportState.Failed);

		return httpMessage;
	}
	private async Task<ExportedFile> GetExportedFile(
		Guid reportId,
		Guid groupId,
		Export export /* Get from the PollExportRequest response */)
	{
		if (export.Status == ExportState.Succeeded)
		{
			// The 'Client' object is an instance of the Power BI .NET SDK
			AuthenticationResult authenticationResult = null;
			authenticationResult = await DoAuthentication();
			var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

			_client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);
			var fileStream = await _client.Reports.GetFileOfExportToFileAsync(groupId, reportId, export.Id);
			return new ExportedFile
		{
			FileStream = fileStream,
			FileSuffix = export.ResourceFileExtension,
		};
		}
		return null;
	}

	public class ExportedFile
	{
		public Stream FileStream;
		public string FileSuffix;
	}
	private async Task ExportReport(FileFormat format)
	{
		if (!String.IsNullOrEmpty(_paramworkspaceId ) && !String.IsNullOrEmpty(_paramreportId))
		{

			if (_isdashboard == "false")
			{
				var clientReport = _client.Reports.GetReport(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));

				_workspaceId = Guid.Parse(_paramworkspaceId);
				_reportId = Guid.Parse(_paramreportId);

				await  ExportPowerBIReport( _reportId,_workspaceId ,format,3,CancellationToken.None);

			}
			else
			{
				var clientDashboard = _client.Dashboards.GetDashboard(Guid.Parse(_paramworkspaceId), Guid.Parse(_paramreportId));

				_workspaceId = Guid.Parse(_paramworkspaceId);
				_reportId = Guid.Parse(_paramreportId);

				await  ExportPowerBIReport( _reportId,_workspaceId ,format,3,CancellationToken.None);

			}

		}
		StateHasChanged();

	}
	private async Task<ExportedFile> ExportPowerBIReport(
		Guid reportId,
		Guid groupId,
		FileFormat format,
		int pollingtimeOutInMinutes,
		CancellationToken token,
		IList<string> pageNames = null,  /* Get the page names from the GetPages REST API */
		string urlFilter = null)
	{
		const int c_maxNumberOfRetries = 3; /* Can be set to any desired number */
		const int c_secToMillisec = 1000;
		try
		{
			Export export = null;
			int retryAttempt = 1;
			do
			{
				var exportId = await PostExportRequest(reportId, groupId, format, pageNames, urlFilter);
				var httpMessage = await PollExportRequest(reportId, groupId, exportId, pollingtimeOutInMinutes, token);
				_exportStatus = _exportStatus + 2;
				 StateHasChanged();
				export = httpMessage.Body;
				if (export == null)
				{
					// Error, failure in exporting the report
					return null;
				}
				if (export.Status == ExportState.Failed)
				{
					// Some failure cases indicate that the system is currently busy. The entire export operation can be retried after a certain delay
					// In such cases the recommended waiting time before retrying the entire export operation can be found in the RetryAfter header
					var retryAfter = httpMessage.Response.Headers.RetryAfter;
					if(retryAfter == null)
					{
						// Failed state with no RetryAfter header indicates that the export failed permanently
						return null;
					}

					var retryAfterInSec = retryAfter.Delta.Value.Seconds;
					await Task.Delay(retryAfterInSec * c_secToMillisec);
				}
			}
			while (export.Status != ExportState.Succeeded && retryAttempt++ < c_maxNumberOfRetries);

			if (export.Status != ExportState.Succeeded)
			{
				// Error, failure in exporting the report
				return null;
			}

			var exportedFile = await GetExportedFile(reportId, groupId, export);

			// Now you have the exported file stream ready to be used according to your specific needs
			// For example, saving the file can be done as follows:

			var pathOnDisk = @"C:\PowerBIReport\" + export.ReportName + exportedFile.FileSuffix;


			using (MemoryStream ms = new MemoryStream())
			{
				exportedFile.FileStream.CopyTo(ms);
				byte[] output = ms.ToArray();
				JSRuntime.InvokeVoidAsync("jsSaveAsFile",
				 export.ReportName+exportedFile.FileSuffix,
				 Convert.ToBase64String(output)
				 );
				ms.Close();
			}

			_exportStatus = 0;
			return exportedFile;
	}
	catch(Exception ex)
	{
		// Error handling
		throw;
	}
}
public static byte[] ReadFully(Stream input)
{
	using (MemoryStream ms = new MemoryStream())
	{
		input.CopyTo(ms);
		return ms.ToArray();
	}
}
public static byte[] ReadToEnd(System.IO.Stream stream)
{
	long originalPosition = 0;

	if(stream.CanSeek)
	{
		 originalPosition = stream.Position;
		 stream.Position = 0;
	}

	try
	{
		byte[] readBuffer = new byte[4096];

		int totalBytesRead = 0;
		int bytesRead;

		while ((bytesRead = stream.Read(readBuffer, totalBytesRead, readBuffer.Length - totalBytesRead)) > 0)
		{
			totalBytesRead += bytesRead;

			if (totalBytesRead == readBuffer.Length)
			{
				int nextByte = stream.ReadByte();
				if (nextByte != -1)
				{
					byte[] temp = new byte[readBuffer.Length * 2];
					Buffer.BlockCopy(readBuffer, 0, temp, 0, readBuffer.Length);
					Buffer.SetByte(temp, totalBytesRead, (byte)nextByte);
					readBuffer = temp;
					totalBytesRead++;
				}
			}
		}

		byte[] buffer = readBuffer;
		if (readBuffer.Length != totalBytesRead)
		{
			buffer = new byte[totalBytesRead];
			Buffer.BlockCopy(readBuffer, 0, buffer, 0, totalBytesRead);
		}
		return buffer;
	}
	finally
	{
		if(stream.CanSeek)
		{
			 stream.Position = originalPosition; 
		}
	}
}

	#endregion
		public class CaptureState
	{
		public string name { get; set; }
		public string displayName { get; set; }
		public string state { get; set; }
	}


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private BlazorDataAnalytics.Services.UserSecurityService.IUserSecurityService _userSecurityService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private BlazorDataAnalytics.Services.ReportDashboardService.IReportDashboardService _reportDashboardService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private BlazorDataAnalytics.Services.ApiClientService.IApiClientService _apiClientService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AuthenticationStateProvider AuthenticationStateProvider { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IReportTheme _reportTheme { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IUserService _userService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IBookmarkService _bookmarkService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager UriHelper { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IConfiguration _configuration { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private BlazorDataAnalytics.Data.FilterState filterstate { get; set; }
    }
}
#pragma warning restore 1591
