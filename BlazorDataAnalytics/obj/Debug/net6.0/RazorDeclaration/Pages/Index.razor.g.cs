// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace BlazorDataAnalytics.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using BlazorDataAnalytics.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Blazored.Modal;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Blazored.Modal.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.DropDowns;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Calendars;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.Spinner;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.SplitButtons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\_Imports.razor"
using Syncfusion.Blazor.RichTextEditor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Enums;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Blazorade.Msal.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Microsoft.Identity.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Microsoft.PowerBI.Api;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Microsoft.PowerBI.Api.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Microsoft.Rest;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Buttons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Cards;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Inputs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Popups;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Lists;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Persistence.Config.Entities;

#line default
#line hidden
#nullable disable
#nullable restore
#line 19 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Grids;

#line default
#line hidden
#nullable disable
#nullable restore
#line 20 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 21 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Navigations;

#line default
#line hidden
#nullable disable
#nullable restore
#line 22 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.ReportService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 23 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.ApiClientService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 24 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.UserReportCardImageService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 25 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.ReportDashboardService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 26 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.UserSecurityService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 27 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.UserService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 28 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.BookMarkService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 29 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.LikeService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 30 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Syncfusion.Blazor.Buttons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 31 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Services.LogService;

#line default
#line hidden
#nullable disable
#nullable restore
#line 32 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using System.IdentityModel.Tokens.Jwt;

#line default
#line hidden
#nullable disable
#nullable restore
#line 33 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 34 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
using BlazorDataAnalytics.Dialogs;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/")]
    public partial class Index : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 215 "C:\Users\Rebo\source\repos\DAaaS\BlazorDataAnalytics\Pages\Index.razor"
 
    MessageBoxDialog MessageDialog;
    private IList<Report>? _reports;
    private IList<Report> _filterReports;
    private IList<Dashboard>? _dashBoards;
    private IList<Bookmark>? _bookmarks;
    private IList<Group>? _group;
    private ReportModel subjectForDelete { get; set; }
    private bool Visibility { get; set; }
    public string Content = "Delete";
    public string CssClass = "e-hide-spinner";
    private IEnumerable<Claim> _claims = Enumerable.Empty<Claim>();
    private ElementReference powerBIElement;
    public IModalService Modal { get; set; }
    private Reports _report;
    private PowerBIClient _client;
    private PowerBIEmbedConfig _result;
    private ReportInDashboard _dboard = new ReportInDashboard();
    private UserTrack userTrack = new UserTrack();
    private Persistence.Config.Entities.User? userDaas = new Persistence.Config.Entities.User();
    private UserNameGroupRolesModel userNameGroupRolesModel = new UserNameGroupRolesModel();

    private List<DataModel> dataModels = new List<DataModel>();
    private List<BookmarkModel> bookmarkModels = new List<BookmarkModel>();
    private List<ReportModel>? reportModels = new List<ReportModel>();
    private List<TagModel>? tagModels = new List<TagModel>();
    private List<ReportModel>? reportFilterModels = new List<ReportModel>();
    private List<DataModel> dataFilterModels = new List<DataModel>();
    private List<String> styleModels = new List<String>();


    private Guid _workspaceId, _reportId;
    private int _customerTenantId;

    private bool isChecked = true;
    private bool showSpinner = true;
    private int countDBoard = 0;

    private bool showSelectAllCheckBox { get; set; } = true;
    private bool enableSelectionOrders { get; set; } = true;
    private bool enableDropDownIcon { get; set; } = true;
    private bool checkSelectAll { get; set; } = true;
    private bool dropDownButton { get; set; } = true;
    private bool selectionReorder { get; set; } = true;
    private bool isNoWorkspace { get; set; } = false;
    private bool isNoReports { get; set; } = false;
    private bool visibility { get; set; }

    private string userId { get; set; }
    private string reportName { get; set; }
    public string clientIPAddr { get; private set; }
    private string authMessage { get; set; }
    private object ipaddress { get; set; }

    private string browser { get; set; }
    private string[] tagArguments { get;  set; }
    private string userNameIdentity { get; set; }

    protected string userName { get; set; }
    private string userEmail { get; set; }
    private string curUrl;

    public bool ShowItem = true;

    void ShowHideItemClick()
    {
        ShowItem = !ShowItem;
    }
    private async Task DeleteDashboard()
    {

        if(subjectForDelete != null)
        {
            try
            {
                await _reportService.DeleteReportAsync(subjectForDelete.Id);

                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                var message = "Deleted Report :" + subjectForDelete.Name;
                var log = new LogModel { Date =  System.DateTime.Now, UserEmail = user.Identity.Name, Message = message, Module = "Dataset"  };
                await _logService.Log(log);

                PowerBIClient _client;
                PowerBIEmbedConfig _result;
                AuthenticationResult authenticationResult = null;
                authenticationResult = await DoAuthentication();

                var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

                _result = new PowerBIEmbedConfig();
                _client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

                _client.Reports.DeleteReport(_workspaceId, subjectForDelete.Id);
            }
            catch (Exception ex) { }
        }
        this.Visibility = !this.Visibility;

        //  reportModels = reportModels.Where(x => x.Id != subjectForDelete.Id).ToList();
        UriHelper.NavigateTo($"/", true);
        StateHasChanged();
    }

    private async Task OnBtnClick(ReportModel _report)
    {
        this.Visibility = !this.Visibility;
        if(this.Visibility ){

            subjectForDelete = _report;
        }

    }
    public void Begin(Syncfusion.Blazor.SplitButtons.ProgressEventArgs args)
    {
        Content = "Deleting...";
        CssClass = "e-hide-spinner e-info border-radius";
    }
    public async Task End(Syncfusion.Blazor.SplitButtons.ProgressEventArgs args)
    {
        await DeleteDashboard();
        Content = "Deleted";
        CssClass = "e-hide-spinner e-success border-radius";
        await Task.Delay(1000);
        Content = "Delete";
        CssClass = "e-hide-spinner border-radius";

    }
    public void RowSelectingHandler(RowSelectingEventArgs<DataModel> args)
    {
        var reporModel = reportModels.FirstOrDefault(x => x.Name == args.Data.Name);
        if(reporModel != null)
        {
            if(reporModel.ReportType.Contains("Dashboard"))
            {
                UriHelper.NavigateTo($"/reports/{_workspaceId}/{reporModel.Id}/false/true");
            }
            else
            {
                UriHelper.NavigateTo($"/reports/{_workspaceId}/{reporModel.Id}/false/false");
            }
        }
    }

    private const string AuthorityFormat = "https://login.microsoftonline.com/94e6b5f2-d1da-4de9-a4ca-88cfdb6c3de0/v2.0";
    private const string MSGraphScope = "https://analysis.windows.net/powerbi/api/.default";
    private async Task<AuthenticationResult> DoAuthentication()
    {
        IConfidentialClientApplication daemonClient;
        daemonClient = ConfidentialClientApplicationBuilder.Create(_configuration.GetSection("AzureAd:ClientId").Value)
            .WithAuthority(string.Format(AuthorityFormat, _configuration.GetSection("AzureAd:TenantId").Value))
            .WithClientSecret(_configuration.GetSection("AzureAd:ClientSecret").Value)
            .Build();

        AuthenticationResult authResult = await daemonClient.AcquireTokenForClient(new[] { MSGraphScope }).ExecuteAsync();
        return authResult;
    }


    public async Task TagValueChangeHandler(MultiSelectChangeEventArgs<string[]> args) 
    {
        showSpinner = true;
        reportModels = new List<ReportModel>();
        List<ReportModel> newReportFilterModels = new List<ReportModel>();

        if (args.Value != null)
        {
            tagArguments = args.Value;
            foreach (var arg in args.Value)
            {
                if (string.IsNullOrEmpty(reportName))
                {
                    newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(arg)).ToList();
                    if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
                    {
                        reportModels.AddRange(newReportFilterModels);                       
                    }
                }
                else
                {
                    newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(arg) && x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();
                    if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
                    {
                        reportModels.AddRange(newReportFilterModels);                       
                    }
                }
            }
        }
        else
        {
            tagArguments =  new string[] {};
            reportModels = reportFilterModels;
        }
        showSpinner = false;
    }


    public async Task ValueChangeHandler(ChangedEventArgs args) 
    {
        showSpinner = true;
        reportModels = new List<ReportModel>();
        List<ReportModel> newReportFilterModels = new List<ReportModel>();

        if(tagArguments != null)
        {
            if(tagArguments.Any())
            {
                foreach (var tagArg in tagArguments)
                {
                    if (string.IsNullOrEmpty(reportName))
                    {
                        newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(tagArg)).ToList();
                        if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
                        {
                            reportModels.AddRange(newReportFilterModels);                       
                        }
                    }
                    else
                    {
                        newReportFilterModels = reportFilterModels.Where(x => x.Tag.Contains(tagArg) && x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();
                        if(newReportFilterModels.Any() && !reportModels.Any(x => newReportFilterModels.Any(a => a.Name == x.Name)))
                        {
                            reportModels.AddRange(newReportFilterModels);                       
                        }
                    }
                }
            }
            else
            {
                reportModels = reportFilterModels.Where(x => x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();
            }

        }     
        else
        {
            if (!string.IsNullOrEmpty(reportName))
            {
                reportModels = reportFilterModels.Where(x => x.Name.ToUpper().Contains(reportName.ToUpper())).ToList();;
            }
            else
            {
                reportModels = reportFilterModels;  
            }
        }
        showSpinner = false;

    }

    public interface ICloneable<T>
    {
        T Clone();
    }


    protected override async Task OnInitializedAsync()
    {
        filterstate.OnChange += StateHasChanged;
        styleModels.Add("Card");
        styleModels.Add("List");        
        await InitializePowerBiReportsAndDashboards();
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {

            showSpinner = true;
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            userTrack =  await _apiClientService.GetUserIPAsync();

            if (user.Identity.IsAuthenticated)
            {
                authMessage = $"{user.Identity.Name} is authenticated.";
                _claims = user.Claims;
                userName = _claims?.FirstOrDefault(x => x.Type.Equals("name", StringComparison.OrdinalIgnoreCase))?.Value;
                userEmail = _claims?.FirstOrDefault(x => x.Type.Equals("preferred_username", StringComparison.OrdinalIgnoreCase))?.Value;

            }
            else
            {
                authMessage = "The user is NOT authenticated.";
            }


            userTrack.Browser = string.Empty;
            userTrack.Browser = string.Empty;
            userTrack.DateTimeLog = DateTime.Now;
            userTrack.UserName = userName;
            userTrack.UserEmail = userEmail;
            userTrack.ReportName = "";
            userTrack.Page= "index";

            using (var db = new DataAnalyticsDBContext())
            {
                try
                {
                    db.Add(userTrack);

                    db.SaveChanges();
                }
                catch (Exception ex)
                {

                    Console.WriteLine( "\nError Message ---\n{0}", ex.Message );
                }

            }
            showSpinner = false;
        }
    }

    private async Task ReportChangeHandler(ChangeEventArgs<Guid, Report> args)
    {
        _reportId = args.ItemData.Id;

        var generateTokenRequestParameters = new GenerateTokenRequest(accessLevel: "view");
        var tokenResponse = _client.Reports.GenerateTokenAsync(new Guid(_workspaceId.ToString()), new Guid(_reportId.ToString()), generateTokenRequestParameters).Result;

        _result.EmbedToken = tokenResponse;
        _result.EmbedUrl = args.ItemData.EmbedUrl;
        _result.Id = args.ItemData.Id.ToString();
        await Interop.CreateReport(JSRuntime, powerBIElement, tokenResponse.Token, args.ItemData.EmbedUrl, args.ItemData.Id.ToString());
    }

    private async Task AddSubLikeDislike(bool Like,string Name)
    {

        var userModel = new UserModel
        {
            userName = userTrack.UserName,
            Email = userTrack.UserEmail
        };

        _dboard.Title = Name;

        try
        {
            var objUser =  await _userService.GetUsersName(userTrack.UserName);

            if (objUser == null)
            {
                await _userService.UpsertUserAsync(userModel);
            }

            var reportInDashboards = await _reportDashboardService.GetReportsInDashboardByTenantId(_customerTenantId,await GetCustomerTenantSid());
            var objDaas = reportInDashboards.FirstOrDefault(c => c.Title == _dboard.Title); 

            if (objDaas == null)
            {
                var customerUserRole = new CustomerUserRole
                {
                    CustomerTernantId = _customerTenantId,
                    Description = $"View {objDaas.Title} Report",
                    UserRoleName = objDaas.Title,
                    IsActive = true,
                };

                string reportRoleCode = await _userSecurityService.InsertCustomerUserRoleByName(customerUserRole);
                await _reportDashboardService.UpsertReportInDashboard(objDaas.Title, objDaas.ReportPowerBiId, reportRoleCode);
            }

            var user = await _userService.GetUsers(userEmail);

            var likeModel = new LikeModel
            {
                UserId = user.userID,
                ReportDbid = objDaas.ReportDbId,
                Title = _dboard.Title,
                IsLike = Like,
                CustomerTenantID = _customerTenantId,
            };

            await _likeService.UpsertLikeAsync(likeModel);

            var objLikes = new List<LikeModel>();
            var objDisLikes = new List<LikeModel>();
            var _countDislike = 0;
            var _countLike = 0;

            var likeMod = await _likeService.GetLikesInDashboardByReportDbId(objDaas.ReportDbId,_customerTenantId);

            objLikes = likeMod.Where(c => c.Title == Name && c.IsLike == true && c.CustomerTenantID == _customerTenantId).ToList();
            _countLike = objLikes.Count;

            objDisLikes = likeMod.Where(c => c.Title == Name && c.IsLike == false && c.CustomerTenantID == _customerTenantId).ToList();
            _countDislike = objDisLikes.Count;

            if (reportModels != null)
            {
                foreach(var obj in reportModels)
                {
                    if(obj.Name == Name)
                    {
                        obj.CntLike = _countLike;
                        obj.CntDislike = _countDislike;
                        break;
                    }
                }
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine("\nError Message ---\n{0}", ex.Message);
        }
    }

    private async Task AddBookmark(string Name,bool isActive)
    {

        var searchUserModel = new UserModel
        {
            userName = userTrack.UserName ?? string.Empty
        };

        var searchDashboardModel = new ReportDashboardModel
        {
            Title = Name
        };

        var objUser =  await _userService.GetUsersName(searchUserModel.userName);
        var dbBoard  = await _reportDashboardService.GetReportsInDashboardByTitle(searchDashboardModel.Title);

        var searchBookmarkModel = new BookmarkModel
        {
            Title = Name,
            UserId = objUser.userID,
            ReportDbid = dbBoard.ReportDbId,
            IsActive = isActive
        };


        try
        {
            var bookMark = await _bookmarkService.UpsertBookmark(searchBookmarkModel);


            bookmarkModels = await _bookmarkService.GetBookmarksByUserAndIsActive(searchBookmarkModel);

            var reportInDashboards = await _reportDashboardService.GetReportsInDashboardByTenantId(_customerTenantId,await GetCustomerTenantSid());

            if (reportModels != null)
            {
                foreach(var obj in reportModels)
                {
                    var reportBoard = reportInDashboards.FirstOrDefault(x => x.ReportPowerBiId == obj.Id); 

                    var bookMarkperReport = await _bookmarkService.GetBookmarkInDashboardByReportDbIdAndUserId(reportBoard.ReportDbId,objUser.userID);

                    if(obj.Name == Name)
                    {
                        obj.IsBookMark = bookMarkperReport == null ? false :bookMarkperReport.IsActive;
                        break;
                    }
                }

            }

        }
        catch (Exception ex)
        {

            Console.WriteLine("\nError Message ---\n{0}", ex.Message);
        }
        StateHasChanged();

    }
    private async Task StyleChangeHandler(Syncfusion.Blazor.DropDowns.ChangeEventArgs<String, String> args)
    {
        if (args.Value == "Card")
        {

            isChecked = true;
        }
        else
        {
            isChecked = false;
        }

    }
    private async Task BookmarkChangeHandler(Syncfusion.Blazor.DropDowns.ChangeEventArgs<String, BookmarkModel> args)
    {      
        _report = await _client.Reports.GetReportsInGroupAsync(_workspaceId);
        _reports = _report.Value;


        Report clientReport = _reports.Where(c=>c.Name == args.ItemData.Title).SingleOrDefault();
        ReportModel reportModel = new ReportModel()
            {
                Id = clientReport.Id,
                Name = clientReport.Name,
                DatasetId = clientReport.DatasetId,
                AppId = clientReport.AppId,
                Description = clientReport.Description,
                ReportType = clientReport.ReportType,
                WebUrl = clientReport.WebUrl,
                EmbedUrl = clientReport.EmbedUrl,
            };

        await GoToReport(reportModel, "false", "false");
    }

    private async Task GoToDashboard(Dashboard dashboard,string editable = "false",string isdashboard="false")
    {
        UriHelper.NavigateTo($"/reports/{_workspaceId.ToString()}/{dashboard.Id}/{editable}/{isdashboard}");
    }


    private async Task GoToReport(ReportModel report,string editable = "false",string isdashboard="false")
    {
        if (report.ReportType.Contains("Dashboard"))
        {
            isdashboard = "true";
            UriHelper.NavigateTo($"/reports/{_workspaceId.ToString()}/{report.Id}/{editable}/{isdashboard}");
        }else
        {
            UriHelper.NavigateTo($"/reports/{_workspaceId.ToString()}/{report.Id}/{editable}/{isdashboard}");
        }
        filterstate.SetFilterShow(report.WebUrl);
    }

    public async Task<string> GetCustomerTenantSid()
    {
        string resource = "https://management.azure.com";
        var clientId = _configuration.GetSection("AzureAd:ClientId").Value;
        var secret = _configuration.GetSection("AzureAd:ClientSecret").Value;
        var oauthUrl = _configuration.GetSection("AzureAd:Instance").Value + _configuration.GetSection("workSpaceId").Value + "/oauth2/token";
        var content = new FormUrlEncodedContent(new Dictionary <string, string> {
                                      { "client_id", clientId},
                                      { "client_secret", secret},
                                      { "grant_type", "client_credentials" },
                                      { "resource", resource},
                                      { "scope", "user_impersonation"}
                                    });

        var httpRequestMessage = new HttpRequestMessage(HttpMethod.Post, new Uri(oauthUrl))
                            {
                                Content = content
                            };

        var _httpClient = new HttpClient();
        using (var response = await _httpClient.SendAsync(httpRequestMessage))
        {
            if (response.IsSuccessStatusCode)
            {
                var responseStream = await response.Content.ReadAsStringAsync();

                AnalyticsTokenModel analyticsToken = JsonConvert.DeserializeObject<AnalyticsTokenModel>(responseStream);

                var handler = new JwtSecurityTokenHandler();
                var jsonToken = handler.ReadToken(analyticsToken.access_token);
                var tokenS = jsonToken as JwtSecurityToken;

                if (tokenS.Claims.First(claim => claim.Type == "groups") != null)
                {
                    return tokenS.Claims.First(claim => claim.Type == "groups").Value;
                } 

            }
        }

        return "";
    }

    private async Task InitializePowerBiReportsAndDashboards()
    {
        showSpinner = true;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userNameIdentity = user?.Identity?.Name;

        userNameGroupRolesModel = await _userSecurityService.GetUserNameGroupRoles(userNameIdentity); 

        if(userNameGroupRolesModel.WorkspaceId == Guid.Empty)
        {
            showSpinner = false;
            isNoWorkspace = true;
            return;
        }

        AuthenticationResult authenticationResult = null;
        authenticationResult = await DoAuthentication();
        var tokenCredentials = new TokenCredentials(authenticationResult.AccessToken, "Bearer");

        _result = new PowerBIEmbedConfig();
        _reports = new List<Report>();
        _client = new PowerBIClient(new Uri("https://api.powerbi.com/"), tokenCredentials);

        _workspaceId = userNameGroupRolesModel.WorkspaceId; //new Guid("c0c75e4f-c69b-4b0f-a7a5-855c5ebcd6da"); // Aged Care Demos workspace
        _customerTenantId = userNameGroupRolesModel.CustomerTenantId;
        _report = await _client.Reports.GetReportsInGroupAsync(_workspaceId);       
        //_dashBoards = _client.Dashboards.GetDashboards(_workspaceId).Value ?? new List<Dashboard>();

        _reports = _report.Value;
        _filterReports = _report.Value;


        if (user.Identity.IsAuthenticated)
        {
            authMessage = $"{user.Identity.Name} is authenticated.";
            _claims = user.Claims;
            userName = _claims?.FirstOrDefault(x => x.Type.Equals("name", StringComparison.OrdinalIgnoreCase))?.Value;

            var userModel = new UserModel
            {
                userName = userName,
                Email = userNameIdentity
            };

            await _userService.UpsertUserAsync(userModel);
        }


        await RenderReportAndDashboard();
        showSpinner = false;
    }
    private void showAlertMessage(string alertType, string message, string title)
    {
        MessageDialog.OpenDialog(alertType,message);
    }
    private async Task RenderReportAndDashboard()
    {      

        foreach  (var item in _filterReports)
        {
            item.Description = string.IsNullOrEmpty(item.Description) ? string.Empty : item.Description;
        }

        var reportInDashboards = await _reportDashboardService.GetReportsInDashboardByTenantId(_customerTenantId, await GetCustomerTenantSid());

        foreach (var reportInDashboard in reportInDashboards)
        {
            bool hasUserRole = await _userSecurityService.CheckUserGroupRole(userNameIdentity, reportInDashboard.UserRoleCode);
            if (reportInDashboard.Tags != null && (hasUserRole || userNameGroupRolesModel.ViewAllReport))
            {
                string[] tagLines = reportInDashboard.Tags.Split(',');

                foreach (var tag in tagLines)
                {
                    var tagModel = new TagModel
                    {
                      Code = tag,
                      TagName = tag
                    };

                    if (!string.IsNullOrEmpty(tagModel.TagName))
                    {
                        tagModels.Add(tagModel);    
                    }
                }
                tagModels = tagModels.DistinctBy(d => d.Code).ToList();
            }
        }

        bookmarkModels = await _reportDashboardService.GetBookmarksInDashboardByTenantId(_customerTenantId, userNameIdentity);

        if((!userNameGroupRolesModel.IsAdmin || !userNameGroupRolesModel.ViewAllReport) && reportInDashboards != null)
        {
            bookmarkModels = bookmarkModels.Where(r => userNameGroupRolesModel.CustomerUserRoles.Any(a => a.Code == 
                                                    reportInDashboards?.FirstOrDefault(x => x.ReportDbId == r.ReportDbid).UserRoleCode)).ToList();
        }

        var user = await _userService.GetUsers(userNameIdentity);

        //realtime dashboard report
        //foreach (var dashboard in _dashBoards)
        //{
        //    var customerUserRole = new CustomerUserRole
        //    {
        //        CustomerTernantId = _customerTenantId,
        //        Description = $"View {dashboard.DisplayName} Report",
        //        UserRoleName = dashboard.DisplayName,
        //        IsActive = true,
        //    };

        //    string reportRoleCode = await _userSecurityService.InsertCustomerUserRoleByName(customerUserRole);

        //    string newTitle = await _reportDashboardService.UpsertReportInDashboard(dashboard.DisplayName, dashboard.Id, reportRoleCode);
        //    dashboard.DisplayName = newTitle;

        //    var reportBoard = reportInDashboards.FirstOrDefault(x => x.ReportPowerBiId == dashboard.Id); 

        //    string realTimeDbTagList = string.Empty;

        //    var realtimedbBoard = reportInDashboards.FirstOrDefault(x => x.ReportPowerBiId == dashboard.Id); 

        //    if(realtimedbBoard != null && userNameGroupRolesModel != null && !string.IsNullOrEmpty(userNameIdentity))
        //    {
        //        var bookMarkperReport = await _bookmarkService.GetBookmarkInDashboardByReportDbIdAndUserId(reportBoard.ReportDbId, user.userID);

        //        if(!userNameGroupRolesModel.IsAdmin && !userNameGroupRolesModel.ViewAllReport)
        //        {
        //            if (!userNameGroupRolesModel.CustomerUserRoles.Any(x => x.Code == realtimedbBoard.UserRoleCode))
        //            {
        //                continue;
        //            }
        //        }

        //        if (!string.IsNullOrEmpty(realtimedbBoard.Tags))
        //        {
        //            string[] tagLines = realtimedbBoard.Tags.Split(',');
        //            foreach (var tag in tagLines)
        //            {
        //                realTimeDbTagList = realTimeDbTagList + "\n" + tag;
        //            }
        //        } 
        //        string editable = "false";
        //        string isdashboard = "true";
        //        dashboard.WebUrl = $"/reports/{_workspaceId}/{dashboard.Id}/{editable}/{isdashboard}";

        //        var rptRealTimeDashboardDataModel = new DataModel
        //        {
        //            Name = dashboard.DisplayName,
        //            Tag = string.IsNullOrEmpty(realtimedbBoard.Tags) ? string.Empty : realtimedbBoard.Tags,
        //            Description = string.Empty
        //        };

        //        dataModels.Add(rptRealTimeDashboardDataModel);

        //        var rptRealTimeDashboardReport = new ReportModel
        //        {
        //            Id = dashboard.Id,
        //            Name = dashboard.DisplayName,
        //            DatasetId = string.Empty,
        //            AppId = dashboard.AppId,
        //            ReportType = "Dashboard",
        //            Description = string.Empty,
        //            TagDashBoard = realTimeDbTagList,
        //            WebUrl = dashboard.WebUrl,
        //            EmbedUrl = _userReportCardImageService.GetUserReportCardImageBlobURLByReportTitle(dashboard.DisplayName).Result,
        //            Tag = string.IsNullOrEmpty(realtimedbBoard.Tags) ? string.Empty : realtimedbBoard.Tags,
        //            IsBookMark = bookMarkperReport == null ? false : bookMarkperReport.IsActive,
        //            IsAdmin = userNameGroupRolesModel.IsAdmin,
        //        };

        //        reportModels.Add(rptRealTimeDashboardReport);


        //    }

        //}

        //power bi reports
        foreach (var item in _reports)
        {
            try {

                var customerUserRole = new CustomerUserRole
                {
                    CustomerTernantId = _customerTenantId,
                    Description = $"View {item.Name} Report",
                    UserRoleName = item.Name,
                    IsActive = true,
                };


                string reportRoleCode = await _userSecurityService.InsertCustomerUserRoleByName(customerUserRole);

                string newTitle = await _reportDashboardService.UpsertReportInDashboard(item.Name, item.Id, reportRoleCode);

                string reportTagList = string.Empty;
                item.Name = newTitle;
                item.EmbedUrl = _userReportCardImageService.GetUserReportCardImageBlobURLByReportTitle(item.Name).Result;

                var reportBoard = reportInDashboards.FirstOrDefault(x => x.ReportPowerBiId.ToString().Equals(item.Id.ToString(), StringComparison.OrdinalIgnoreCase));

                if (reportBoard != null)
                {

                    var likeReports = await _likeService.GetLikesInDashboardByReportDbId(reportBoard.ReportDbId, _customerTenantId);
                    int countLike = likeReports.Where(x => x.IsLike == true).Count();
                    int countDislike = likeReports.Where(x => x.IsLike == false).Count();
                    var bookMarkperReport = new BookmarkModel();
                    try
                    {
                        bookMarkperReport = await _bookmarkService.GetBookmarkInDashboardByReportDbIdAndUserId(reportBoard.ReportDbId, user.userID);
                    }
                    catch (Exception ex) { }
                    if (!userNameGroupRolesModel.IsAdmin)
                    {
                        if (!userNameGroupRolesModel.CustomerUserRoles.Any(x => x.Code == reportBoard.UserRoleCode) && !userNameGroupRolesModel.ViewAllReport)
                        {
                            continue;
                        }
                    }

                    if (!string.IsNullOrEmpty(reportBoard.Tags))
                    {
                        string[] tagLines = reportBoard.Tags.Split(',');
                        foreach (var tag in tagLines)
                        {
                            reportTagList = reportTagList + "\n" + tag;
                        }
                    }

                    string editable = "false";
                    string isdashboard = "false";
                    item.WebUrl = $"/reports/{_workspaceId}/{item.Id}/{editable}/{isdashboard}";

                    var rptPowerBIReport = new DataModel
                        {
                            Name = item.Name,
                            Tag = string.IsNullOrEmpty(reportBoard.Tags) ? string.Empty : reportBoard.Tags,
                            Description = item.Description,

                        };

                    dataModels.Add(rptPowerBIReport);

                    var rptRealTimeDashboardReport = new ReportModel
                        {
                            Id = item.Id,
                            Name = item.Name,
                            DatasetId = item.DatasetId,
                            AppId = item.AppId,
                            Description = item.Description,
                            ReportType = item.ReportType,
                            WebUrl = item.WebUrl,
                            EmbedUrl = item.EmbedUrl,
                            TagDashBoard = reportTagList,
                            Tag = string.IsNullOrEmpty(reportBoard.Tags) ? string.Empty : reportBoard.Tags,
                            CntLike = countLike,
                            CntDislike = countDislike,
                            IsBookMark = bookMarkperReport == null ? false : bookMarkperReport.IsActive,
                            IsAdmin = userNameGroupRolesModel.IsAdmin,
                        };

                    reportModels.Add(rptRealTimeDashboardReport);
               
           }
         }catch (Exception ex) { }
        }

        reportFilterModels = reportModels;
        isNoReports = !reportModels.Any();
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ILogService _logService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ILikeService _likeService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private BlazorDataAnalytics.Data.FilterState filterstate { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IReportService _reportService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IBookmarkService _bookmarkService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IUserService _userService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IUserSecurityService _userSecurityService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IReportDashboardService _reportDashboardService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IUserReportCardImageService _userReportCardImageService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IApiClientService _apiClientService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager UriHelper { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AuthenticationStateProvider AuthenticationStateProvider { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IConfiguration _configuration { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
    }
}
#pragma warning restore 1591
